\chapter{Type Safety of \Surface}
\label{ch:type-safety}

\section{Type Safety of \CC by Progress and Preservation}
\label{sec:cc-type-safety}

We first prove that substitution preserves types:

\begin{lemma}[Substitution preserves types]
  \label{lem:subst-pres}
  If $(\Gamma,x{:}A);\Sigma;g;\ell\vdash N \Leftarrow B$ and \\
  $\forall g'\,\ell'.\,\Gamma;\Sigma;g';\ell' \vdash V \Leftarrow A$, then
  $\Gamma;\Sigma;g\;\ell \vdash N[x:=V] \Leftarrow B$.
\end{lemma}
\begin{proof}
  The proof is fully mechanized in \texttt{/src/CC2/SubstPreserve.agda}.
\end{proof}

We show that \CC is type safe by proving progress and preservation. Progress
says that a well-typed \CC term does not get stuck. The term is either a value
or a blame, which does not reduce, or the term takes one reduction step.

\begin{theorem}[Progress]
\label{thm:progress}
Suppose \PC is well-typed: $\vdash \PC \Leftarrow g$,
$M$ is well-typed:
\[
\emptyset ; \Sigma ; g ; | \PC | \vdash M \Leftarrow A
\]
and the heap $\mu$ is also well-typed: $\Sigma \vdash \mu$.
Then either (1) $M$ is a value or (2) $M$ is a blame: {\normalfont $M = \blame{p}$}
or (3) $M$ can take a reduction step:
$\reduce{M}{\mu}{\PC}{N}{\mu'}$ for some $N$ and $\mu'$.
\end{theorem}
\begin{proof}
  The proof is fully mechanized in \texttt{progress} of \texttt{/src/CC2/Progress.agda}.
\end{proof}

Heap well-typedness is defined point-wise (in \texttt{/src/Memory/HeapTyping.agda}):

\begin{align*}
\Sigma \vdash \mu \triangleq & \forall n\,\ell\,T.\,\text{if}~\Sigma(\ell,n)=T \text{, then}~\mu(\ell,n)=V \\
& \text{and}~\emptyset;\Sigma;\low;\low\vdash V \Leftarrow T_{\ell} ~\text{for some}~ V
\end{align*}

The operation semantics of \CC preserves types and the well-typedness of heap:

\begin{theorem}[Preservation]
\label{thm:preservation}
Suppose \PC is well-typed:  $\vdash \PC \Leftarrow g$,
$M$ is well-typed: $\emptyset ; \Sigma ; g ; |\PC| \vdash M \Leftarrow A$
and the heap $\mu$ is also well-typed: $\Sigma \vdash \mu$.
If $\reduce{M}{\mu}{\PC}{N}{\mu'}$, there exists $\Sigma'$ s.t
$\Sigma' \supseteq \Sigma$, $\emptyset ; \Sigma' ; g ; |\PC| \vdash N \Leftarrow A$,
and $\Sigma' \vdash \mu'$.
\end{theorem}
\begin{proof}
  The proof is fully mechanized in \texttt{pres} of \texttt{/src/CC2/Preservation.agda}.
\end{proof}

\section{Compilation From \CC to \Surface Preserves Types}
\label{sec:compile-pres}

We prove that the compilation from \Surface to \CC (defined in
Chapter~\ref{ch:compile}) preserves types:

\begin{theorem}[Compilation preserves types]
  \label{thm:compile-pres}
  If $M$ is a well-typed \Surface program: $\Gamma ; g \vdash M : A$, then the
  compiled \CC term is also well-typed: $\Gamma ; \emptyset ; g ; \low \vdash
  \compile{M} \Leftarrow A$.
\end{theorem}
\begin{proof}
  The proof is fully mechanized in
  \texttt{/src/Compile/CompilationPresTypes.agda}.
\end{proof}

\section{Type Safety of \Surface}
\label{sec:surface-type-safety}

\begin{figure}[tbp]
  \raggedright
  \fbox{$\vdash r : A$}
  \begin{gather*}
    \inference{k : \iota}{\vdash k : \iota_{\ell}}
    \quad
    \inference{}{\vdash \mathit{addr} : (\Refer{A})_{g}}
    \quad
    \inference{}{\vdash \mathit{fun} : (\Fun{A}{g_2}{B})_{g_1}}
    \quad
    \inference{}{\vdash \mathit{diverge} : A}
  \end{gather*}
  \caption{Well-typed evaluation result}
  \label{fig:wt-result}
\end{figure}

Leading to the type safety for \Surface, we first prove that multi-step
reduction of \CC preserves types, which is a direct corollary of
Theorem~\ref{thm:preservation}:

\begin{lemma}
  \label{thm:pres-mult}
  Suppose $\emptyset ; \Sigma ; \low ; \low \vdash M \Leftarrow A$ and $\Sigma \vdash \mu$.
  If $\reducemult{M}{\mu}{\low}{M'}{\mu'}$,
  then there exists $\Sigma'$ s.t $\Sigma' \supseteq \Sigma$, $\emptyset ; \Sigma' ; \low ; \low \vdash M' \Leftarrow A$,
  and $\Sigma' \vdash \mu'$.
\end{lemma}
\begin{proof}
  Mechanized in \texttt{pres-mult} of \texttt{/src/CC2/MultiStep.agda}. By
  induction on the reduction sequence.
\end{proof}

We then prove the following lemma about the evaluation of \CC:

\begin{lemma}
  \label{thm:pres-bigstep}
  If $\emptyset ; \Sigma ; \low ; \low \vdash M \Leftarrow A$ and $\Sigma \vdash
  \mu$, then either (1) $M \mid \mu \Downarrow V \mid \mu'$ and $\emptyset ;
  \Sigma' ; \low ; \low \vdash V \Leftarrow A$ for some $\Sigma', \mu'$, or (2)
  $M \mid \mu \Downarrow \blame{p} \mid \mu'$ for some $\bl{p}, \mu'$, or (3) $M
  \mid \mu \Uparrow$.
\end{lemma}
\begin{proof}
  By Theorem~\ref{thm:progress} (progress), $M$ is a value or a blame, or $M$
  can take a reduction step.
  \begin{itemize}
    \item If $M$ is a value or a blame, the lemma is trivially true.
    \item Otherwise, if $M$ takes on step, we have
      $\reduce{M}{\mu}{\low}{N}{\mu'}$ for some $N,\mu'$. By
      Theorem~\ref{thm:preservation} (preservation), $N$ is well-typed:
      $\emptyset ; \Sigma' ; \low ; \low \vdash N \Leftarrow A$ for some
      $\Sigma'$, and the heap is also well-typed: $\Sigma' \vdash \mu'$. If $N$
      is a value or a blame, the goal is proved by taking one step from $M$ to
      $N$, and then from $N$ to the resulting value or blame (induction
      hypothesis). Otherwise, $N$ diverges; $M$ takes one step to $N$, so $M$
      also diverges.
  \end{itemize}
\end{proof}

Finally, we prove type safety for \Surface:

\begin{theorem}[Type Safety of \Surface]
  \label{thm:type-safety}
  If $M$ is a well-typed \Surface program: $(x{:}\Bool_{\high});\low \vdash M : \Bool_{\low}$
  and $\mathit{eval}(M,b)=r$,
  then the result is also well-typed: $\vdash r : \Bool_{\low}$.
\end{theorem}
%% \begin{proof}
%%   Casing on $r$ yields three cases:
%%   \begin{itemize}
%%     \item $r=b$.
%%     \item $r=\mathit{error}\;\bl{p}$.
%%     \item $r=\mathit{diverge}$.
%%   \end{itemize}
%% \end{proof}
